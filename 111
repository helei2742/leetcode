close_detail as (
select	td_order_id
	from ipd_ops_sdi.sdi_t_ticket_td_order_operation_record
	where to_status in  ('4','20','30')
	group by td_order_id
),
not_close_detail as (
select	td_order_id
		,to_status
		,operate_datetime
		,sum(case
			when to_status = nvl(lag_to_status,to_status) then 0
			else 1
		end ) over(partition by td_order_id order by operate_datetime asc) as label
	from
		(select	td_order_id
				,to_status
				,operate_datetime
				,lag(nvl(to_status,'-1')) over(partition by td_order_id order by operate_datetime asc) as lag_to_status
			from ipd_ops_sdi.sdi_t_ticket_td_order_operation_record t1
			where not exists(select 1
								from close_detail t2
								where t2.td_order_id = t1.td_order_id)
		) t2
),



WITH close_detail AS (
    SELECT 
        td_order_id
    FROM 
        ipd_ops_sdi.sdi_t_ticket_td_order_operation_record
    WHERE 
        to_status IN ('4', '20', '30')
    GROUP BY 
        td_order_id
),
not_close_detail AS (
    SELECT 
        t1.td_order_id,
        t1.to_status,
        t1.operate_datetime,
        SUM(CASE 
                WHEN t1.to_status = COALESCE(LAG(t1.to_status) OVER (PARTITION BY t1.td_order_id ORDER BY t1.operate_datetime), t1.to_status) THEN 0 
                ELSE 1 
            END) OVER (PARTITION BY t1.td_order_id ORDER BY t1.operate_datetime ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS label
    FROM 
        ipd_ops_sdi.sdi_t_ticket_td_order_operation_record t1
    LEFT JOIN 
        close_detail t2 ON t1.td_order_id = t2.td_order_id
    WHERE 
        t2.td_order_id IS NULL
)
